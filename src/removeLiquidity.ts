import { Token, TokenAmount } from '@traderjoe-xyz/sdk-core';
import {
    createPublicClient,
    createWalletClient,
    http,
    parseUnits,
    getContract,
} from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { bsc, bscTestnet } from 'viem/chains';
import { config } from 'dotenv';

config(); // Load .env file

if (!process.env.PRIVATE_KEY) {
    throw new Error('PRIVATE_KEY not found in .env file');
}

const MODE = process.env.MODE || 'dev';

// Make sure private key is properly formatted
const privateKey = process.env.PRIVATE_KEY.startsWith('0x') 
    ? process.env.PRIVATE_KEY 
    : `0x${process.env.PRIVATE_KEY}`;

const account = privateKeyToAccount(privateKey as `0x${string}`);

// Chain configuration
const chain = MODE === "dev" ? bscTestnet : bsc;

// Create Viem clients (public and wallet)
const publicClient = createPublicClient({
    chain: chain,
    transport: http()
});

const walletClient = createWalletClient({
    account,
    chain: chain,
    transport: http()
});

// PancakeSwap V2 Router address
const routerAddress = MODE === "dev" 
    ? "0xD99D1c33F9fC3444f8101754aBC46c52416550D1" // BSCÊµãËØïÁΩë
    : "0x10ED43C718714eb63d5aA57B78B54704E256024E"; // BSC‰∏ªÁΩë

// TraderJoe V2.2 Router address
const traderJoeRouterAddress = MODE === "dev"
    ? "0x8FABE13D95F28f7478Dc655d8D4BA99935D50e02" // BSCÊµãËØïÁΩë TraderJoe V2.2
    : "0xb4315e873dBcf96Ffd0acd8EA43f689D8c20fB30"; // BSC‰∏ªÁΩë TraderJoe V2.2

// Chain ID
const CHAIN_ID = MODE === "dev" ? 97 : 56;

// Bin step for TraderJoe V2.2
const BIN_STEP = "1";

// PancakeSwap V2 Router ABI (ÊµÅÂä®ÊÄßÁßªÈô§Áõ∏ÂÖ≥ÊñπÊ≥ï)
const PANCAKE_ROUTER_ABI = [
    {
        "inputs": [
            { "internalType": "address", "name": "tokenA", "type": "address" },
            { "internalType": "address", "name": "tokenB", "type": "address" },
            { "internalType": "uint256", "name": "liquidity", "type": "uint256" },
            { "internalType": "uint256", "name": "amountAMin", "type": "uint256" },
            { "internalType": "uint256", "name": "amountBMin", "type": "uint256" },
            { "internalType": "address", "name": "to", "type": "address" },
            { "internalType": "uint256", "name": "deadline", "type": "uint256" }
        ],
        "name": "removeLiquidity",
        "outputs": [
            { "internalType": "uint256", "name": "amountA", "type": "uint256" },
            { "internalType": "uint256", "name": "amountB", "type": "uint256" }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            { "internalType": "address", "name": "token", "type": "address" },
            { "internalType": "uint256", "name": "liquidity", "type": "uint256" },
            { "internalType": "uint256", "name": "amountTokenMin", "type": "uint256" },
            { "internalType": "uint256", "name": "amountETHMin", "type": "uint256" },
            { "internalType": "address", "name": "to", "type": "address" },
            { "internalType": "uint256", "name": "deadline", "type": "uint256" }
        ],
        "name": "removeLiquidityETH",
        "outputs": [
            { "internalType": "uint256", "name": "amountToken", "type": "uint256" },
            { "internalType": "uint256", "name": "amountETH", "type": "uint256" }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    }
] as const;

// TraderJoe V2.2 LB Pair ABI (essential functions)
const LBPairV21ABI = [
    {
        "inputs": [
            { "internalType": "address[]", "name": "accounts", "type": "address[]" },
            { "internalType": "uint256[]", "name": "ids", "type": "uint256[]" }
        ],
        "name": "balanceOfBatch",
        "outputs": [{ "internalType": "uint256[]", "name": "", "type": "uint256[]" }],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            { "internalType": "address", "name": "account", "type": "address" },
            { "internalType": "address", "name": "operator", "type": "address" }
        ],
        "name": "isApprovedForAll",
        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            { "internalType": "address", "name": "operator", "type": "address" },
            { "internalType": "bool", "name": "approved", "type": "bool" }
        ],
        "name": "setApprovalForAll",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    }
] as const;

// TraderJoe V2.2 Router ABI (remove liquidity function)
const LBRouterV22ABI = [
    {
        "inputs": [
            { "internalType": "address", "name": "tokenX", "type": "address" },
            { "internalType": "address", "name": "tokenY", "type": "address" },
            { "internalType": "uint16", "name": "binStep", "type": "uint16" },
            { "internalType": "uint256", "name": "amountXMin", "type": "uint256" },
            { "internalType": "uint256", "name": "amountYMin", "type": "uint256" },
            { "internalType": "uint256[]", "name": "ids", "type": "uint256[]" },
            { "internalType": "uint256[]", "name": "amounts", "type": "uint256[]" },
            { "internalType": "address", "name": "to", "type": "address" },
            { "internalType": "uint256", "name": "deadline", "type": "uint256" }
        ],
        "name": "removeLiquidity",
        "outputs": [
            { "internalType": "uint256", "name": "amountX", "type": "uint256" },
            { "internalType": "uint256", "name": "amountY", "type": "uint256" }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    }
] as const;

// TraderJoe V2.2 Factory ABI
const LBFactoryABI = [
    {
        "inputs": [
            { "internalType": "address", "name": "tokenA", "type": "address" },
            { "internalType": "address", "name": "tokenB", "type": "address" },
            { "internalType": "uint256", "name": "binStep", "type": "uint256" }
        ],
        "name": "getLBPairInformation",
        "outputs": [
            {
                "components": [
                    { "internalType": "uint16", "name": "binStep", "type": "uint16" },
                    { "internalType": "address", "name": "LBPair", "type": "address" },
                    { "internalType": "bool", "name": "createdByOwner", "type": "bool" },
                    { "internalType": "bool", "name": "ignoredForRouting", "type": "bool" }
                ],
                "internalType": "struct ILBFactory.LBPairInformation",
                "name": "lbPairInformation",
                "type": "tuple"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
] as const;

// PancakeSwap V2 Factory and Pair ABI
const PANCAKE_FACTORY_ABI = [
    {
        "inputs": [
            { "internalType": "address", "name": "tokenA", "type": "address" },
            { "internalType": "address", "name": "tokenB", "type": "address" }
        ],
        "name": "getPair",
        "outputs": [{ "internalType": "address", "name": "pair", "type": "address" }],
        "stateMutability": "view",
        "type": "function"
    }
] as const;

const PAIR_ABI = [
    {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }],
        "name": "balanceOf",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getReserves",
        "outputs": [
            { "internalType": "uint112", "name": "reserve0", "type": "uint112" },
            { "internalType": "uint112", "name": "reserve1", "type": "uint112" },
            { "internalType": "uint32", "name": "blockTimestampLast", "type": "uint32" }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            { "internalType": "address", "name": "spender", "type": "address" },
            { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            { "internalType": "address", "name": "owner", "type": "address" },
            { "internalType": "address", "name": "spender", "type": "address" }
        ],
        "name": "allowance",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
    }
] as const;

// PancakeSwap V2 Factory address
const factoryAddress = MODE === "dev"
    ? "0xB7926C0430Afb07AA7DEfDE6DA862aE0Bde767bc" // BSCÊµãËØïÁΩë PancakeSwap V2 Factory
    : "0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73"; // BSC‰∏ªÁΩë

// TraderJoe V2.2 Factory address
const traderJoeFactoryAddress = MODE === "dev"
    ? "0x8e42f2F4101563bF679975178e880FD87d3eFd4e" // BSCÊµãËØïÁΩë TraderJoe V2.2 Factory
    : "0x8e42f2F4101563bF679975178e880FD87d3eFd4e"; // BSC‰∏ªÁΩë TraderJoe V2.2 Factory

/**
 * ÁßªÈô§ USDC-USDT ÊµÅÂä®ÊÄß
 * @param {string} liquidityPercentage - Ë¶ÅÁßªÈô§ÁöÑÊµÅÂä®ÊÄßÁôæÂàÜÊØî (Â¶Ç "50" Ë°®Á§∫ 50%)
 * @param {number} slippagePercent - ÊªëÁÇπÂÆπÂøçÂ∫¶ÁôæÂàÜÊØî (Â¶Ç 0.5 Ë°®Á§∫ 0.5%)
 * @returns {Promise<string>} - ‰∫§ÊòìÂìàÂ∏å
 */
export async function removeLiquidityUSDCUSDT(
    liquidityPercentage: string = "100",
    slippagePercent: number = 0.5
): Promise<string> {
    try {
        console.log("üèä‚Äç‚ôÄÔ∏è ÂºÄÂßãÁßªÈô§ USDC-USDT ÊµÅÂä®ÊÄß");
        console.log("   ÁΩëÁªú:", MODE === "dev" ? "BSC ÊµãËØïÁΩë" : "BSC ‰∏ªÁΩë");
        console.log("   ÁßªÈô§ÊØî‰æã:", `${liquidityPercentage}%`);
        console.log("   ÊªëÁÇπÂÆπÂøçÂ∫¶:", `${slippagePercent}%`);

        // ÂÆö‰πâ‰ª£Â∏ÅÂú∞ÂùÄ
        const USDC_ADDRESS = MODE === "dev"
            ? "0x64544969ed7EBf5f083679233325356EbE738930"
            : "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";

        const USDT_ADDRESS = MODE === "dev"
            ? "0x337610d27c682E347C9cD60BD4b3b107C9d34dDd"
            : "0x55d398326f99059fF775485246999027B3197955";

        // Ëé∑ÂèñÈÖçÂØπÂú∞ÂùÄ
        const pairAddress = await publicClient.readContract({
            address: factoryAddress as `0x${string}`,
            abi: PANCAKE_FACTORY_ABI,
            functionName: "getPair",
            args: [USDC_ADDRESS as `0x${string}`, USDT_ADDRESS as `0x${string}`]
        });

        if (pairAddress === "0x0000000000000000000000000000000000000000") {
            throw new Error("USDC-USDT ÊµÅÂä®ÊÄßÊ±†‰∏çÂ≠òÂú®");
        }

        console.log("   ÈÖçÂØπÂú∞ÂùÄ:", pairAddress);

        // Ëé∑ÂèñÁî®Êà∑ÁöÑLP‰ª£Â∏Å‰ΩôÈ¢ù
        const lpBalance = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "balanceOf",
            args: [account.address]
        });

        if (lpBalance === BigInt(0)) {
            throw new Error("ÊÇ®Âú®ËØ•ÊµÅÂä®ÊÄßÊ±†‰∏≠Ê≤°ÊúâÊµÅÂä®ÊÄß");
        }

        console.log("   LP‰ª£Â∏Å‰ΩôÈ¢ù:", lpBalance.toString());

        // ËÆ°ÁÆóË¶ÅÁßªÈô§ÁöÑÊµÅÂä®ÊÄßÊï∞Èáè
        const liquidityToRemove = (lpBalance * BigInt(liquidityPercentage)) / BigInt(100);
        console.log("   Ë¶ÅÁßªÈô§ÁöÑÊµÅÂä®ÊÄß:", liquidityToRemove.toString());

        // Ëé∑ÂèñÊ±†Â≠êÂÇ®Â§áÈáèÊù•‰º∞ÁÆóÊúÄÂ∞èËæìÂá∫
        const reserves = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "getReserves",
            args: []
        });

        const totalSupply = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "totalSupply",
            args: []
        });

        // ËÆ°ÁÆóÈ¢ÑÊúüËæìÂá∫ (ÁÆÄÂåñËÆ°ÁÆó)
        const expectedUSDC = (reserves[0] * liquidityToRemove) / totalSupply;
        const expectedUSDT = (reserves[1] * liquidityToRemove) / totalSupply;

        // Â∫îÁî®ÊªëÁÇπÂÆπÂøçÂ∫¶
        const slippageMultiplier = BigInt(Math.floor((100 - slippagePercent) * 100));
        const minUSDC = (expectedUSDC * slippageMultiplier) / BigInt(10000);
        const minUSDT = (expectedUSDT * slippageMultiplier) / BigInt(10000);

        console.log("   È¢ÑÊúü USDC:", expectedUSDC.toString());
        console.log("   È¢ÑÊúü USDT:", expectedUSDT.toString());
        console.log("   ÊúÄÂ∞è USDC:", minUSDC.toString());
        console.log("   ÊúÄÂ∞è USDT:", minUSDT.toString());

        // ÊâπÂáÜLP‰ª£Â∏ÅÁªôË∑ØÁî±Âô®
        await approveLPTokenIfNeeded(pairAddress, routerAddress, liquidityToRemove);

        // ËÆæÁΩÆÊà™Ê≠¢Êó∂Èó¥
        const deadline = BigInt(Math.floor(Date.now() / 1000) + 1800);

        console.log("\nüîÑ ÊâßË°åÁßªÈô§ÊµÅÂä®ÊÄß‰∫§Êòì...");

        // Ê®°Êãü‰∫§Êòì
        const { request } = await publicClient.simulateContract({
            address: routerAddress as `0x${string}`,
            abi: PANCAKE_ROUTER_ABI,
            functionName: "removeLiquidity",
            args: [
                USDC_ADDRESS as `0x${string}`,
                USDT_ADDRESS as `0x${string}`,
                liquidityToRemove,
                minUSDC,
                minUSDT,
                account.address,
                deadline
            ],
            account
        });

        // ÂèëÈÄÅ‰∫§Êòì
        const txHash = await walletClient.writeContract(request);
        console.log("‚úÖ ÁßªÈô§ÊµÅÂä®ÊÄß‰∫§ÊòìÂ∑≤ÂèëÈÄÅ! ÂìàÂ∏å:", txHash);

        // Á≠âÂæÖÁ°ÆËÆ§
        const receipt = await publicClient.waitForTransactionReceipt({ 
            hash: txHash as `0x${string}` 
        });
        console.log("üéâ ÊµÅÂä®ÊÄßÁßªÈô§ÊàêÂäü! Âå∫Âùó:", receipt.blockNumber);

        return txHash;
    } catch (error) {
        console.error("‚ùå ÁßªÈô§ÊµÅÂä®ÊÄßÂ§±Ë¥•:", error);
        throw error;
    }
}

/**
 * ÁßªÈô§ BNB-USDC ÊµÅÂä®ÊÄß
 * @param {string} liquidityPercentage - Ë¶ÅÁßªÈô§ÁöÑÊµÅÂä®ÊÄßÁôæÂàÜÊØî
 * @param {number} slippagePercent - ÊªëÁÇπÂÆπÂøçÂ∫¶ÁôæÂàÜÊØî
 * @returns {Promise<string>} - ‰∫§ÊòìÂìàÂ∏å
 */
export async function removeLiquidityBNBUSDC(
    liquidityPercentage: string = "100",
    slippagePercent: number = 0.5
): Promise<string> {
    try {
        console.log("üèä‚Äç‚ôÄÔ∏è ÂºÄÂßãÁßªÈô§ BNB-USDC ÊµÅÂä®ÊÄß");

        const USDC_ADDRESS = MODE === "dev"
            ? "0x64544969ed7EBf5f083679233325356EbE738930"
            : "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";

        const WBNB_ADDRESS = MODE === "dev"
            ? "0xae13d989daC2f0dEbFf460aC112a837C89BAa7cd"
            : "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";

        // Ëé∑ÂèñÈÖçÂØπÂú∞ÂùÄ
        const pairAddress = await publicClient.readContract({
            address: factoryAddress as `0x${string}`,
            abi: PANCAKE_FACTORY_ABI,
            functionName: "getPair",
            args: [WBNB_ADDRESS as `0x${string}`, USDC_ADDRESS as `0x${string}`]
        });

        if (pairAddress === "0x0000000000000000000000000000000000000000") {
            throw new Error("BNB-USDC ÊµÅÂä®ÊÄßÊ±†‰∏çÂ≠òÂú®");
        }

        const lpBalance = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "balanceOf",
            args: [account.address]
        });

        if (lpBalance === BigInt(0)) {
            throw new Error("ÊÇ®Âú®ËØ•ÊµÅÂä®ÊÄßÊ±†‰∏≠Ê≤°ÊúâÊµÅÂä®ÊÄß");
        }

        const liquidityToRemove = (lpBalance * BigInt(liquidityPercentage)) / BigInt(100);

        // Ëé∑ÂèñÂÇ®Â§áÈáèÂíåÊÄª‰æõÂ∫îÈáè
        const reserves = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "getReserves",
            args: []
        });

        const totalSupply = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "totalSupply",
            args: []
        });

        // ËÆ°ÁÆóÈ¢ÑÊúüËæìÂá∫ (ÈúÄË¶ÅÁ°ÆÂÆöÂì™‰∏™ÊòØWBNBÂì™‰∏™ÊòØUSDC)
        const expectedWBNB = (reserves[0] * liquidityToRemove) / totalSupply;
        const expectedUSDC = (reserves[1] * liquidityToRemove) / totalSupply;

        const slippageMultiplier = BigInt(Math.floor((100 - slippagePercent) * 100));
        const minWBNB = (expectedWBNB * slippageMultiplier) / BigInt(10000);
        const minUSDC = (expectedUSDC * slippageMultiplier) / BigInt(10000);

        console.log("   ÁßªÈô§ÊØî‰æã:", `${liquidityPercentage}%`);
        console.log("   LP‰ª£Â∏Å:", liquidityToRemove.toString());

        // ÊâπÂáÜLP‰ª£Â∏Å
        await approveLPTokenIfNeeded(pairAddress, routerAddress, liquidityToRemove);

        const deadline = BigInt(Math.floor(Date.now() / 1000) + 1800);

        const { request } = await publicClient.simulateContract({
            address: routerAddress as `0x${string}`,
            abi: PANCAKE_ROUTER_ABI,
            functionName: "removeLiquidityETH",
            args: [
                USDC_ADDRESS as `0x${string}`,
                liquidityToRemove,
                minUSDC,
                minWBNB,
                account.address,
                deadline
            ],
            account
        });

        const txHash = await walletClient.writeContract(request);
        console.log("‚úÖ BNB-USDC ÊµÅÂä®ÊÄßÁßªÈô§‰∫§ÊòìÂ∑≤ÂèëÈÄÅ:", txHash);

        await publicClient.waitForTransactionReceipt({ 
            hash: txHash as `0x${string}` 
        });
        console.log("üéâ BNB-USDC ÊµÅÂä®ÊÄßÁßªÈô§ÊàêÂäü!");

        return txHash;
    } catch (error) {
        console.error("‚ùå ÁßªÈô§ BNB-USDC ÊµÅÂä®ÊÄßÂ§±Ë¥•:", error);
        throw error;
    }
}

/**
 * Ëé∑ÂèñÁî®Êà∑Âú®ÊåáÂÆöÊµÅÂä®ÊÄßÊ±†‰∏≠ÁöÑ‰ø°ÊÅØ
 * @param {string} type - ÊµÅÂä®ÊÄßÊ±†Á±ªÂûã ("usdc-usdt" Êàñ "bnb-usdc")
 * @returns {Promise<object>} - ÊµÅÂä®ÊÄß‰ø°ÊÅØ
 */
export async function getLiquidityInfo(type: string): Promise<any> {
    try {
        let tokenA, tokenB;
        
        if (type === "usdc-usdt") {
            tokenA = MODE === "dev" ? "0x64544969ed7EBf5f083679233325356EbE738930" : "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";
            tokenB = MODE === "dev" ? "0x337610d27c682E347C9cD60BD4b3b107C9d34dDd" : "0x55d398326f99059fF775485246999027B3197955";
        } else if (type === "bnb-usdc") {
            tokenA = MODE === "dev" ? "0xae13d989daC2f0dEbFf460aC112a837C89BAa7cd" : "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
            tokenB = MODE === "dev" ? "0x64544969ed7EBf5f083679233325356EbE738930" : "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";
        } else {
            throw new Error("Êó†ÊïàÁöÑÊµÅÂä®ÊÄßÊ±†Á±ªÂûã");
        }

        // Ëé∑ÂèñÈÖçÂØπÂú∞ÂùÄ
        const pairAddress = await publicClient.readContract({
            address: factoryAddress as `0x${string}`,
            abi: PANCAKE_FACTORY_ABI,
            functionName: "getPair",
            args: [tokenA as `0x${string}`, tokenB as `0x${string}`]
        });

        if (pairAddress === "0x0000000000000000000000000000000000000000") {
            return {
                exists: false,
                lpBalance: "0",
                reserves: null,
                share: "0"
            };
        }

        // Ëé∑ÂèñÁî®Êà∑LP‰ΩôÈ¢ù
        const lpBalance = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "balanceOf",
            args: [account.address]
        });

        // Ëé∑ÂèñÊÄª‰æõÂ∫îÈáèÂíåÂÇ®Â§áÈáè
        const totalSupply = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "totalSupply",
            args: []
        });

        const reserves = await publicClient.readContract({
            address: pairAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "getReserves",
            args: []
        });

        // ËÆ°ÁÆóÁî®Êà∑‰ªΩÈ¢ù
        const sharePercentage = totalSupply > 0 
            ? ((Number(lpBalance) / Number(totalSupply)) * 100).toFixed(4)
            : "0";

        return {
            exists: true,
            pairAddress,
            lpBalance: lpBalance.toString(),
            totalSupply: totalSupply.toString(),
            reserves: {
                reserve0: reserves[0].toString(),
                reserve1: reserves[1].toString()
            },
            sharePercentage,
            type
        };
    } catch (error) {
        console.error("Ëé∑ÂèñÊµÅÂä®ÊÄß‰ø°ÊÅØÂ§±Ë¥•:", error);
        throw error;
    }
}

/**
 * ÁßªÈô§ TraderJoe V2.2 USDC-USDT ÊµÅÂä®ÊÄß
 * @param {string} liquidityPercentage - Ë¶ÅÁßªÈô§ÁöÑÊµÅÂä®ÊÄßÁôæÂàÜÊØî (Â¶Ç "50" Ë°®Á§∫ 50%)
 * @param {number} slippagePercent - ÊªëÁÇπÂÆπÂøçÂ∫¶ÁôæÂàÜÊØî (Â¶Ç 0.5 Ë°®Á§∫ 0.5%)
 * @returns {Promise<string>} - ‰∫§ÊòìÂìàÂ∏å
 */
export async function removeLiquidityTraderJoeUSDCUSDT(
    liquidityPercentage: string = "100",
    slippagePercent: number = 0.5
): Promise<string> {
    try {
        console.log("üèä‚Äç‚ôÄÔ∏è ÂºÄÂßãÁßªÈô§ TraderJoe V2.2 USDC-USDT ÊµÅÂä®ÊÄß");
        console.log("   ÁΩëÁªú:", MODE === "dev" ? "BSC ÊµãËØïÁΩë" : "BSC ‰∏ªÁΩë");
        console.log("   ÁßªÈô§ÊØî‰æã:", `${liquidityPercentage}%`);
        console.log("   ÊªëÁÇπÂÆπÂøçÂ∫¶:", `${slippagePercent}%`);

        // ÂÆö‰πâ‰ª£Â∏ÅÂú∞ÂùÄ
        const USDC_ADDRESS = MODE === "dev"
            ? "0x64544969ed7EBf5f083679233325356EbE738930"
            : "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";

        const USDT_ADDRESS = MODE === "dev"
            ? "0x337610d27c682E347C9cD60BD4b3b107C9d34dDd"
            : "0x55d398326f99059fF775485246999027B3197955";

        // Ëé∑ÂèñTraderJoe LB Pair‰ø°ÊÅØ
        const lbPairInfo = await publicClient.readContract({
            address: traderJoeFactoryAddress as `0x${string}`,
            abi: LBFactoryABI,
            functionName: "getLBPairInformation",
            args: [USDC_ADDRESS as `0x${string}`, USDT_ADDRESS as `0x${string}`, BigInt(BIN_STEP)]
        });

        if (lbPairInfo.LBPair === "0x0000000000000000000000000000000000000000") {
            throw new Error("TraderJoe USDC-USDT ÊµÅÂä®ÊÄßÊ±†‰∏çÂ≠òÂú®");
        }

        console.log("   LB Pair Âú∞ÂùÄ:", lbPairInfo.LBPair);

        // Ëé∑ÂèñÂΩìÂâçÊ¥ªË∑ÉbinÂë®Âõ¥ÁöÑËåÉÂõ¥
        const range = 200;
        const activeBinId = 8388608; // ÈªòËÆ§Ê¥ªË∑Ébin ID

        // ÂáÜÂ§áÂú∞ÂùÄÂíåbinÊï∞ÁªÑ
        const addressArray = Array.from({ length: 2 * range + 1 }).fill(account.address);
        const binsArray = [];
        for (let i = activeBinId - range; i <= activeBinId + range; i++) {
            binsArray.push(BigInt(i));
        }

        // Ëé∑ÂèñÁî®Êà∑Âú®ÊâÄÊúâbins‰∏≠ÁöÑ‰ΩôÈ¢ù
        const allBins = await publicClient.readContract({
            address: lbPairInfo.LBPair as `0x${string}`,
            abi: LBPairV21ABI,
            functionName: 'balanceOfBatch',
            args: [addressArray as `0x${string}`[], binsArray]
        });

        // Á≠õÈÄâÂá∫Áî®Êà∑Êã•ÊúâÁöÑbins
        const userOwnedBins = binsArray.filter((bin, index) => allBins[index] !== BigInt(0));
        const nonZeroAmounts = allBins.filter(amount => amount !== BigInt(0));

        if (userOwnedBins.length === 0) {
            throw new Error("ÊÇ®Âú®ËØ•TraderJoeÊµÅÂä®ÊÄßÊ±†‰∏≠Ê≤°ÊúâÊµÅÂä®ÊÄß");
        }

        console.log("   Áî®Êà∑Êã•ÊúâÁöÑbins:", userOwnedBins.length);

        // Ê†πÊçÆÁôæÂàÜÊØîËÆ°ÁÆóË¶ÅÁßªÈô§ÁöÑÊï∞Èáè
        const percentage = BigInt(liquidityPercentage);
        const adjustedAmounts = nonZeroAmounts.map(amount => 
            (amount * percentage) / BigInt(100)
        );

        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊâπÂáÜ
        const approved = await publicClient.readContract({
            address: lbPairInfo.LBPair as `0x${string}`,
            abi: LBPairV21ABI,
            functionName: 'isApprovedForAll',
            args: [account.address, traderJoeRouterAddress as `0x${string}`]
        });

        if (!approved) {
            console.log("   ÈúÄË¶ÅÊâπÂáÜLBÂØπË∑ØÁî±Âô®ÁöÑÊìç‰ΩúÊùÉÈôê");
            const { request } = await publicClient.simulateContract({
                address: lbPairInfo.LBPair as `0x${string}`,
                abi: LBPairV21ABI,
                functionName: 'setApprovalForAll',
                args: [traderJoeRouterAddress as `0x${string}`, true],
                account
            });
            
            const hashApproval = await walletClient.writeContract(request);
            console.log(`   ‚úÖ ÊâπÂáÜ‰∫§ÊòìÂìàÂ∏å: ${hashApproval}`);
            
            await publicClient.waitForTransactionReceipt({ 
                hash: hashApproval as `0x${string}` 
            });
            console.log("   ‚úÖ ÊâπÂáÜÊàêÂäü");
        }

        // ËÆæÁΩÆ‰∫§ÊòìÊà™Ê≠¢Êó∂Èó¥
        const currentTimeInSec = Math.floor(Date.now() / 1000);
        const deadline = BigInt(currentTimeInSec + 3600);

        console.log("\nüîÑ ÊâßË°åTraderJoeÁßªÈô§ÊµÅÂä®ÊÄß‰∫§Êòì...");

        // Ê®°ÊãüÂπ∂ÂèëÈÄÅÁßªÈô§ÊµÅÂä®ÊÄß‰∫§Êòì
        const { request } = await publicClient.simulateContract({
            address: traderJoeRouterAddress as `0x${string}`,
            abi: LBRouterV22ABI,
            functionName: "removeLiquidity",
            args: [
                USDC_ADDRESS as `0x${string}`,
                USDT_ADDRESS as `0x${string}`,
                Number(BIN_STEP),
                BigInt(0), // amountXMin - ÁÆÄÂåñÁ§∫‰æã‰∏≠ËÆæ‰∏∫0
                BigInt(0), // amountYMin - ÁÆÄÂåñÁ§∫‰æã‰∏≠ËÆæ‰∏∫0
                userOwnedBins,
                adjustedAmounts,
                account.address,
                deadline
            ],
            account
        });

        const removalHash = await walletClient.writeContract(request);
        console.log("‚úÖ TraderJoeÊµÅÂä®ÊÄßÁßªÈô§‰∫§ÊòìÂ∑≤ÂèëÈÄÅ! ÂìàÂ∏å:", removalHash);

        // Á≠âÂæÖÁ°ÆËÆ§
        const receipt = await publicClient.waitForTransactionReceipt({ 
            hash: removalHash as `0x${string}` 
        });
        console.log("üéâ TraderJoeÊµÅÂä®ÊÄßÁßªÈô§ÊàêÂäü! Âå∫Âùó:", receipt.blockNumber);

        return removalHash;
    } catch (error) {
        console.error("‚ùå ÁßªÈô§TraderJoeÊµÅÂä®ÊÄßÂ§±Ë¥•:", error);
        throw error;
    }
}

function sleep(ms: number): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, ms));
}

async function approveLPTokenIfNeeded(
    lpTokenAddress: string,
    spender: string, 
    amount: bigint
): Promise<void> {
    try {
        // Ê£ÄÊü•ÂΩìÂâçÊâπÂáÜÈ¢ùÂ∫¶
        const allowanceResult = await publicClient.readContract({
            address: lpTokenAddress as `0x${string}`,
            abi: PAIR_ABI,
            functionName: "allowance",
            args: [account.address, spender as `0x${string}`],
        });

        const currentAllowance = BigInt(allowanceResult?.toString() || '0');
        console.log(`   ÂΩìÂâçLP‰ª£Â∏ÅÊâπÂáÜÈ¢ùÂ∫¶Ôºö${currentAllowance.toString()}`);

        if (currentAllowance < amount) {
            console.log(`   ÈúÄË¶ÅÊâπÂáÜLP‰ª£Â∏ÅÊîØÂá∫`);

            const { request } = await publicClient.simulateContract({
                address: lpTokenAddress as `0x${string}`,
                abi: PAIR_ABI,
                functionName: "approve",
                args: [spender as `0x${string}`, amount],
                account
            });

            const txHash = await walletClient.writeContract(request);
            console.log(`   ‚úÖ LP‰ª£Â∏ÅÊâπÂáÜ‰∫§ÊòìÂìàÂ∏å: ${txHash}`);

            await publicClient.waitForTransactionReceipt({ 
                hash: txHash as `0x${string}` 
            });
            console.log(`   ‚úÖ LP‰ª£Â∏ÅÊâπÂáÜÊàêÂäü`);

            await sleep(2000);
        } else {
            console.log(`   ‚úÖ LP‰ª£Â∏ÅÊâπÂáÜÈ¢ùÂ∫¶ÂÖÖË∂≥`);
        }
    } catch (error) {
        console.error(`   ‚ùå ÊâπÂáÜLP‰ª£Â∏ÅÂ§±Ë¥•:`, error);
        throw error;
    }
}
